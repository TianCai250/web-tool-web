import{_ as A,C as F,r as L,a as O,B as Y,D as G,t as Q,b as d,o as l,d as u,e as r,f as i,u as o,i as N,w as p,F as Z,s as K,l as W,E as X,j as S,G as ee,x as H,H as te,I as se}from"./index-023244de.js";import{m as C,H as ne}from"./common-132caf81.js";const oe={class:"ai-image"},ae={class:"question-container"},le={class:"image-choose"},ie={class:"question-btn"},re={class:"answer-list"},ce={class:"answer-icon"},de={key:0,class:"answer-words"},ue=["innerHTML"],pe="a7f148b0",_e="MzNjZDEzYjkxNTE5YjQ3MjU2YmZiNTUx",ge="a894f8068c0dced62fd3df07d48c91de",me={__name:"index",setup(fe){const U=new C.Renderer;C.setOptions({renderer:U,gfm:!0,pedantic:!1,sanitize:!1,highlight:(t,s)=>s?ne.highlight(t,{language:s}).value:t});const E=F().appContext.config.globalProperties.$CryptoJS,f=L(),h=L(),e=O({question:"",list:[],status:"empty",fileList:[]});Y(()=>{const t=J();if(t)try{e.list=JSON.parse(t)}catch(s){console.log(s)}});const I=G(()=>e.question.trim().length===0||["busy"].includes(e.status)||e.fileList.length!==1&&e.list.length===0),j=t=>{console.log(t),t&&(e.fileList=[t],T())},z=t=>{h.value.clearFiles();const s=t[0];s.uid=W(),h.value.handleStart(s)},D=()=>{if(!I.value)if(e.status="busy",e.list.length===0){let t=new FileReader;t.readAsDataURL(e.fileList[0].raw),t.onload=function(){e.list.push({role:"user",content:t.result.split(",")[1],content_type:"image"}),e.list.push({role:"user",content:e.question}),e.question="",y(),R().then(s=>{})}}else e.list.push({role:"user",content:e.question}),e.question="",y(),R().then(t=>{})},R=()=>new Promise((t,s)=>{const _=new Date().toGMTString(),a="spark-api.cn-huabei-1.xf-yun.com",g="/v2.1/image";let w=`host: ${a}
date: ${_}
GET ${g} HTTP/1.1`,x=E.enc.Base64.stringify(E.HmacSHA256(w,_e));const n=`api_key="${ge}", algorithm="hmac-sha256", headers="host date request-line", signature="${x}"`;let k=btoa(n);const B=`wss://${a}${g}?authorization=${k}&date=${encodeURIComponent(_)}&host=${a}`;let c=new WebSocket(B);c.onopen=function(){console.log("sock连接成功!!!!"),c.send(JSON.stringify({header:{app_id:pe},parameter:{chat:{domain:"general",temperature:.5,max_tokens:1024}},payload:{message:{text:e.list}}})),e.list.push({role:"assistant",content:""})},c.onerror=function(m){e.status="empty",console.log("error: ",m),X({type:"error",message:"网络异常"}),s(m)},c.onmessage=function(m){const q=JSON.parse(m.data);if(!q.payload){e.list[e.list.length-1].content="发生错误";return}q.payload.choices.text.forEach(V=>{e.list[e.list.length-1].content+=V.content})},c.onclose=function(){e.status="empty",y(),f.value.scrollTop=f.value.scrollHeight,t(e.list)}}),T=()=>{e.list=[],M()},y=()=>{localStorage.setItem("web_tool_ai_image",JSON.stringify(e.list))},J=()=>localStorage.getItem("web_tool_ai_image"),M=()=>{localStorage.removeItem("web_tool_ai_image")},{question:b,list:P,status:$,fileList:v}=Q(e);return(t,s)=>{const _=d("el-input"),a=d("el-button"),g=d("el-upload"),w=d("el-icon"),x=d("el-image");return l(),u("div",oe,[r("div",ae,[i(_,{type:"textarea",rows:4,resize:"none",placeholder:"请开始您的对话",modelValue:o(b),"onUpdate:modelValue":s[0]||(s[0]=n=>N(b)?b.value=n:null),clearable:""},null,8,["modelValue"]),r("div",le,[i(g,{ref_key:"uploadRef",ref:h,action:"","auto-upload":!1,accept:".jpg,.png,.jpeg,.webp","on-exceed":z,"on-change":j,limit:1,"file-list":o(v),"onUpdate:fileList":s[1]||(s[1]=n=>N(v)?v.value=n:null)},{default:p(()=>[i(a,{style:{"margin-right":"12px"},type:"primary",plain:"",disabled:o($)!=="empty"},{default:p(()=>[S("选择图片")]),_:1},8,["disabled"])]),_:1},8,["file-list"]),r("div",ie,[i(a,{onClick:T,disabled:o($)!=="empty"},{default:p(()=>[S("全新会话")]),_:1},8,["disabled"]),i(a,{type:"info",onClick:D,disabled:I.value},{default:p(()=>[S("发送")]),_:1},8,["disabled"])])])]),r("div",{class:"answer-container",ref_key:"listRef",ref:f},[r("div",re,[(l(!0),u(Z,null,K(o(P),(n,k)=>(l(),u("div",{class:ee(["answer-item",{user:n.role==="user",system:n.role==="assistant"}]),key:k},[r("div",ce,[i(w,null,{default:p(()=>[n.role==="user"?(l(),H(o(te),{key:0})):(l(),H(o(se),{key:1}))]),_:2},1024)]),n.content_type==="image"?(l(),u("div",de,[i(x,{style:{width:"100px"},src:"data:image/png;base64,"+n.content},null,8,["src"])])):(l(),u("div",{key:1,class:"answer-words",innerHTML:n.content===""?"正在生成回答...":o(C)(n.content)},null,8,ue))],2))),128))])],512)])}}},we=A(me,[["__scopeId","data-v-83b74a4a"]]);export{we as default};

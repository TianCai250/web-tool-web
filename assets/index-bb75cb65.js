import{d as B,r as q,a as F,C as O,D as Y,t as G,b as d,e as c,f as l,u as o,i as H,w as p,F as Q,x as Z,G as K,l as W,E as X,m as g,o as i,j as S,H as ee,y as N,I as te,J as se,_ as ne}from"./index-9fca570e.js";import{M as oe,m as ae,H as R}from"./github-fb06b0c3.js";const le={class:"ai-image"},ie={class:"question-container"},re={class:"image-choose"},ce={class:"question-btn"},ue={class:"answer-list"},de={class:"answer-icon"},pe={key:0,class:"answer-words"},ge=["innerHTML"],_e="a7f148b0",fe="MzNjZDEzYjkxNTE5YjQ3MjU2YmZiNTUx",me="a894f8068c0dced62fd3df07d48c91de",he=B({__name:"index",setup(ye){const U=new oe(ae({langPrefix:"hljs language-",highlight(t,s){const r=R.getLanguage(s)?s:"shell";return t&&R.highlight(t,{language:r}).value}})),C=K().appContext.config.globalProperties.$CryptoJS,m=q(),h=q(),e=F({question:"",list:[],status:"empty",fileList:[]});O(()=>{const t=P();if(t)try{e.list=JSON.parse(t)}catch(s){console.log(s)}});const E=Y(()=>e.question.trim().length===0||["busy"].includes(e.status)||e.fileList.length!==1&&e.list.length===0),j=t=>{t&&(e.fileList=[t],L())},J=t=>{h.value.clearFiles();const s=t[0];s.uid=W(),h.value.handleStart(s)},M=()=>{if(!E.value)if(e.status="busy",e.list.length===0){let t=new FileReader;t.readAsDataURL(e.fileList[0].raw),t.onload=function(){e.list.push({role:"user",content:t.result.split(",")[1],content_type:"image"}),e.list.push({role:"user",content:e.question}),e.question="",y(),I().then(s=>{})}}else e.list.push({role:"user",content:e.question}),e.question="",y(),I().then(t=>{})},I=()=>new Promise((t,s)=>{const r=new Date().toUTCString(),a="spark-api.cn-huabei-1.xf-yun.com",_="/v2.1/image";let w=`host: ${a}
date: ${r}
GET ${_} HTTP/1.1`,x=C.enc.Base64.stringify(C.HmacSHA256(w,fe));const n=`api_key="${me}", algorithm="hmac-sha256", headers="host date request-line", signature="${x}"`;let k=btoa(n);const V=`wss://${a}${_}?authorization=${k}&date=${encodeURIComponent(r)}&host=${a}`;let u=new WebSocket(V);u.onopen=function(){console.log("sock连接成功!!!!"),u.send(JSON.stringify({header:{app_id:_e},parameter:{chat:{domain:"general",temperature:.5,max_tokens:1024}},payload:{message:{text:e.list}}})),e.list.push({role:"assistant",content:""})},u.onerror=function(f){e.status="empty",console.log("error: ",f),X({type:"error",message:"网络异常"}),s(f)},u.onmessage=function(f){const $=JSON.parse(f.data);if(!$.payload){e.list[e.list.length-1].content="发生错误";return}$.payload.choices.text.forEach(A=>{e.list[e.list.length-1].content+=A.content})},u.onclose=function(){e.status="empty",y(),m.value.scrollTop=m.value.scrollHeight,t(e.list)}}),L=()=>{e.list=[],z()},y=()=>{localStorage.setItem("web_tool_ai_image",JSON.stringify(e.list))},P=()=>localStorage.getItem("web_tool_ai_image"),z=()=>{localStorage.removeItem("web_tool_ai_image")},{question:b,list:D,status:T,fileList:v}=G(e);return(t,s)=>{const r=g("el-input"),a=g("el-button"),_=g("el-upload"),w=g("el-icon"),x=g("el-image");return i(),d("div",le,[c("div",ie,[l(r,{type:"textarea",rows:4,resize:"none",placeholder:"请开始您的对话",modelValue:o(b),"onUpdate:modelValue":s[0]||(s[0]=n=>H(b)?b.value=n:null),clearable:""},null,8,["modelValue"]),c("div",re,[l(_,{ref_key:"uploadRef",ref:h,action:"","auto-upload":!1,accept:".jpg,.png,.jpeg,.webp","on-exceed":J,"on-change":j,limit:1,"file-list":o(v),"onUpdate:fileList":s[1]||(s[1]=n=>H(v)?v.value=n:null)},{default:p(()=>[l(a,{style:{"margin-right":"12px"},type:"primary",plain:"",disabled:o(T)!=="empty"},{default:p(()=>[S("选择图片")]),_:1},8,["disabled"])]),_:1},8,["file-list"]),c("div",ce,[l(a,{onClick:L,disabled:o(T)!=="empty"},{default:p(()=>[S("全新会话")]),_:1},8,["disabled"]),l(a,{type:"info",onClick:M,disabled:E.value},{default:p(()=>[S("发送")]),_:1},8,["disabled"])])])]),c("div",{class:"answer-container",ref_key:"listRef",ref:m},[c("div",ue,[(i(!0),d(Q,null,Z(o(D),(n,k)=>(i(),d("div",{class:ee(["answer-item",{user:n.role==="user",system:n.role==="assistant"}]),key:k},[c("div",de,[l(w,null,{default:p(()=>[n.role==="user"?(i(),N(o(te),{key:0})):(i(),N(o(se),{key:1}))]),_:2},1024)]),n.content_type==="image"?(i(),d("div",pe,[l(x,{"preview-src-list":["data:image/png;base64,"+n.content],style:{width:"5rem"},src:"data:image/png;base64,"+n.content},null,8,["preview-src-list","src"])])):(i(),d("div",{key:1,class:"answer-words",innerHTML:n.content===""?"正在生成回答...":o(U).parse(n.content)},null,8,ge))],2))),128))])],512)])}}});const ke=ne(he,[["__scopeId","data-v-ff2c44b3"]]);export{ke as default};
